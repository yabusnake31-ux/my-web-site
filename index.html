<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®šç©åˆ†ãƒã‚¹ã‚¿ãƒ¼ - æˆé•·ãŒè¦‹ãˆã‚‹ç·´ç¿’å¸³</title>
  
  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tab-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .tab-button {
      flex: 1;
      padding: 15px;
      border: none;
      background: rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background: white;
      color: #667eea;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.4);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ãƒ©ãƒ³ã‚¯è¡¨ç¤º */
    .rank-display {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 15px;
    }

    .rank-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .rank-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    .xp-bar {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.3);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
    }

    .xp-fill {
      height: 100%;
      background: white;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .xp-text {
      margin-top: 10px;
      font-size: 0.9rem;
    }

    /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .stat-box {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      border-radius: 10px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 900;
      color: #667eea;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 5px;
    }

    /* ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤º */
    .streak-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      border-radius: 15px;
      color: white;
    }

    .streak-icon {
      font-size: 3rem;
    }

    .streak-info {
      text-align: left;
    }

    .streak-number {
      font-size: 2rem;
      font-weight: 900;
    }

    .streak-text {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ */
    .chart-container {
      width: 100%;
      height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ */
    .training-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .problem-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
    }

    .problem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e1e8ed;
    }

    .problem-type {
      font-size: 0.9rem;
      color: #667eea;
      font-weight: 700;
      background: #f0f3ff;
      padding: 8px 15px;
      border-radius: 20px;
    }

    .problem-number {
      font-size: 1rem;
      color: #7f8c8d;
      font-weight: 500;
    }

    .problem-display {
      font-size: 2.5rem;
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 15px;
      margin-bottom: 30px;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hint-section {
      background: #fff9e6;
      border-left: 4px solid #ffd700;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .hint-section.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
    }

    .hint-title {
      font-weight: 700;
      color: #d4a600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .answer-section {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .answer-section.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    .answer-steps {
      margin-bottom: 20px;
    }

    .step {
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      border-radius: 8px;
      font-size: 1.1rem;
    }

    .final-answer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }

    .final-answer-label {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .final-answer-value {
      font-size: 2rem;
      font-weight: 700;
    }

    /* ãƒœã‚¿ãƒ³ */
    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 150px;
      padding: 15px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-hint {
      background: #ffd700;
      color: #333;
    }

    .btn-hint:hover {
      background: #ffc700;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    .btn-show {
      background: #9b59b6;
      color: white;
    }

    .btn-show:hover {
      background: #8e44ad;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
    }

    .btn-correct {
      background: #2ecc71;
      color: white;
    }

    .btn-correct:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
    }

    .btn-incorrect {
      background: #e74c3c;
      color: white;
    }

    .btn-incorrect:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    /* ãƒŸã‚¹åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: white;
      padding: 35px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
    }

    .mistake-options {
      display: grid;
      gap: 12px;
    }

    .mistake-option {
      padding: 15px;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-weight: 600;
    }

    .mistake-option:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
    }

    /* åˆ†æãƒšãƒ¼ã‚¸ */
    .analysis-grid {
      display: grid;
      gap: 20px;
    }

    .mistake-analysis {
      background: white;
      padding: 25px;
      border-radius: 15px;
    }

    .mistake-list {
      display: grid;
      gap: 12px;
      margin-top: 15px;
    }

    .mistake-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .mistake-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .mistake-count {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mistake-bar {
      width: 100px;
      height: 8px;
      background: #e1e8ed;
      border-radius: 4px;
      overflow: hidden;
    }

    .mistake-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.5s ease;
    }

    .mistake-number {
      font-weight: 700;
      color: #667eea;
      font-family: 'JetBrains Mono', monospace;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        min-width: 100%;
      }

      .tab-nav {
        flex-direction: column;
      }
    }

    .loading {
      text-align: center;
      padding: 100px 20px;
      font-size: 1.5rem;
      color: white;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // æ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const MathDisplay = ({ latex, block = false }) => {
      const containerRef = useRef(null);
      useEffect(() => {
        if (containerRef.current && window.katex) {
          try {
            window.katex.render(latex, containerRef.current, {
              throwOnError: false,
              displayMode: block
            });
          } catch (e) {
            containerRef.current.textContent = latex;
          }
        }
      }, [latex, block]);
      return <span ref={containerRef} />;
    };

    // å•é¡Œã‚¿ã‚¤ãƒ—ã®å®šç¾©
    const PROBLEM_TYPES = {
      trigonometric: { name: 'ä¸‰è§’é–¢æ•°', color: '#e74c3c' },
      exponential: { name: 'æŒ‡æ•°é–¢æ•°', color: '#3498db' },
      rational: { name: 'æœ‰ç†é–¢æ•°', color: '#2ecc71' },
      poly_trig: { name: 'å¤šé …å¼Ã—ä¸‰è§’', color: '#f39c12' },
      poly_exp: { name: 'å¤šé …å¼Ã—æŒ‡æ•°', color: '#9b59b6' },
      substitution: { name: 'ç½®æ›ç©åˆ†', color: '#1abc9c' },
      parts: { name: 'éƒ¨åˆ†ç©åˆ†', color: '#e67e22' },
      sqrt_function: { name: 'ç„¡ç†é–¢æ•°', color: '#95a5a6' },
      log_power: { name: 'å¯¾æ•°ç´¯ä¹—', color: '#16a085' },
      trig_power: { name: 'ä¸‰è§’é–¢æ•°ç´¯ä¹—', color: '#c0392b' },
      derivative_over_function: { name: "f'(x)/f(x)", color: '#2980b9' },
      log_derivative: { name: 'å¯¾æ•°å¾®åˆ†', color: '#8e44ad' }
    };

    // ãƒ©ãƒ³ã‚¯ã‚·ã‚¹ãƒ†ãƒ 
    const RANKS = [
      { name: 'ç©åˆ†è¦‹ç¿’ã„', minXP: 0, icon: 'ğŸŒ±' },
      { name: 'ç©åˆ†åˆç´šè€…', minXP: 50, icon: 'ğŸŒ¿' },
      { name: 'ç©åˆ†ä¸­ç´šè€…', minXP: 150, icon: 'ğŸŒ³' },
      { name: 'ç©åˆ†ä¸Šç´šè€…', minXP: 300, icon: 'â­' },
      { name: 'ç©åˆ†é”äºº', minXP: 500, icon: 'ğŸ’«' },
      { name: 'ç©åˆ†é­”è¡“å¸«', minXP: 1000, icon: 'ğŸ”®' },
      { name: 'ç©åˆ†ãƒã‚¹ã‚¿ãƒ¼', minXP: 2000, icon: 'ğŸ‘‘' }
    ];

    // ãƒŸã‚¹ã®ã‚«ãƒ†ã‚´ãƒª
    const MISTAKE_TYPES = [
      'ç©åˆ†å…¬å¼ã®å¿˜ã‚Œ',
      'ç¬¦å·ã®ãƒŸã‚¹',
      'ä»£å…¥è¨ˆç®—ã®ãƒŸã‚¹',
      'æ–¹é‡ã®é–“é•ã„',
      'ãã®ä»–'
    ];

    // å•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆå‰å›ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
    ${generateAllProblemFunctions()}

    function IntegrationMasterApp() {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [currentProblem, setCurrentProblem] = useState(null);
      const [showHint, setShowHint] = useState(false);
      const [showAnswer, setShowAnswer] = useState(false);
      const [showMistakeModal, setShowMistakeModal] = useState(false);
      const [stats, setStats] = useState({
        attempted: 0,
        correct: 0,
        streak: 0,
        lastStudyDate: null,
        xp: 0,
        typeStats: {},
        mistakes: {}
      });
      const radarChartRef = useRef(null);
      const radarChartInstance = useRef(null);

      // åˆæœŸåŒ–
      useEffect(() => {
        const saved = localStorage.getItem('integrationMasterStats');
        if (saved) {
          const parsed = JSON.parse(saved);
          setStats(parsed);
          
          // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¢ºèª
          const today = new Date().toDateString();
          if (parsed.lastStudyDate !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (parsed.lastStudyDate !== yesterday.toDateString()) {
              parsed.streak = 0;
            }
          }
        }
        setCurrentProblem(generateProblem());
      }, []);

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”»
      useEffect(() => {
        if (activeTab === 'dashboard' && radarChartRef.current) {
          const ctx = radarChartRef.current.getContext('2d');
          
          if (radarChartInstance.current) {
            radarChartInstance.current.destroy();
          }

          const types = Object.keys(PROBLEM_TYPES);
          const data = types.map(type => {
            const typeData = stats.typeStats[type] || { attempted: 0, correct: 0 };
            return typeData.attempted > 0 
              ? Math.round((typeData.correct / typeData.attempted) * 100)
              : 0;
          });

          radarChartInstance.current = new Chart(ctx, {
            type: 'radar',
            data: {
              labels: types.map(t => PROBLEM_TYPES[t].name),
              datasets: [{
                label: 'æ­£ç­”ç‡ (%)',
                data: data,
                fill: true,
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: 'rgb(102, 126, 234)',
                pointBackgroundColor: 'rgb(102, 126, 234)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(102, 126, 234)'
              }]
            },
            options: {
              elements: {
                line: {
                  borderWidth: 3
                }
              },
              scales: {
                r: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    stepSize: 20
                  }
                }
              }
            }
          });
        }
      }, [activeTab, stats]);

      // çµ±è¨ˆä¿å­˜
      const saveStats = (newStats) => {
        localStorage.setItem('integrationMasterStats', JSON.stringify(newStats));
        setStats(newStats);
      };

      // ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯å–å¾—
      const getCurrentRank = () => {
        for (let i = RANKS.length - 1; i >= 0; i--) {
          if (stats.xp >= RANKS[i].minXP) {
            return RANKS[i];
          }
        }
        return RANKS[0];
      };

      // æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã®XP
      const getNextRankProgress = () => {
        const currentRank = getCurrentRank();
        const currentIndex = RANKS.indexOf(currentRank);
        if (currentIndex === RANKS.length - 1) {
          return { current: stats.xp, max: stats.xp, percentage: 100 };
        }
        const nextRank = RANKS[currentIndex + 1];
        const current = stats.xp - currentRank.minXP;
        const max = nextRank.minXP - currentRank.minXP;
        return { current, max, percentage: Math.round((current / max) * 100) };
      };

      // å•é¡Œã‚¿ã‚¤ãƒ—ã®çµ±è¨ˆæ›´æ–°
      const updateTypeStats = (type, correct) => {
        const newTypeStats = { ...stats.typeStats };
        if (!newTypeStats[type]) {
          newTypeStats[type] = { attempted: 0, correct: 0 };
        }
        newTypeStats[type].attempted++;
        if (correct) {
          newTypeStats[type].correct++;
        }
        return newTypeStats;
      };

      // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
      const handleShowHint = () => {
        setShowHint(true);
      };

      // ç­”ãˆè¡¨ç¤º
      const handleShowAnswer = () => {
        setShowAnswer(true);
      };

      // æ­£ç­”
      const handleCorrect = () => {
        const today = new Date().toDateString();
        const newStreak = stats.lastStudyDate === today ? stats.streak : stats.streak + 1;
        
        const newStats = {
          ...stats,
          attempted: stats.attempted + 1,
          correct: stats.correct + 1,
          streak: newStreak,
          lastStudyDate: today,
          xp: stats.xp + (showAnswer ? 5 : showHint ? 8 : 10),
          typeStats: updateTypeStats(currentProblem.type, true)
        };
        
        saveStats(newStats);
        nextProblem();
      };

      // å¤±æ•—ï¼ˆãƒŸã‚¹åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
      const handleIncorrect = () => {
        setShowMistakeModal(true);
      };

      // ãƒŸã‚¹è¨˜éŒ²ã—ã¦æ¬¡ã¸
      const recordMistake = (mistakeType) => {
        const today = new Date().toDateString();
        const newStreak = stats.lastStudyDate === today ? stats.streak : stats.streak + 1;
        
        const newMistakes = { ...stats.mistakes };
        newMistakes[mistakeType] = (newMistakes[mistakeType] || 0) + 1;
        
        const newStats = {
          ...stats,
          attempted: stats.attempted + 1,
          streak: newStreak,
          lastStudyDate: today,
          xp: stats.xp + 2,
          typeStats: updateTypeStats(currentProblem.type, false),
          mistakes: newMistakes
        };
        
        saveStats(newStats);
        setShowMistakeModal(false);
        nextProblem();
      };

      // æ¬¡ã®å•é¡Œ
      const nextProblem = () => {
        setCurrentProblem(generateProblem());
        setShowHint(false);
        setShowAnswer(false);
      };

      // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
      const resetStats = () => {
        if (confirm('æœ¬å½“ã«çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          const newStats = {
            attempted: 0,
            correct: 0,
            streak: 0,
            lastStudyDate: null,
            xp: 0,
            typeStats: {},
            mistakes: {}
          };
          saveStats(newStats);
        }
      };

      if (!currentProblem) return <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>;

      const currentRank = getCurrentRank();
      const rankProgress = getNextRankProgress();
      const accuracyRate = stats.attempted > 0 
        ? Math.round((stats.correct / stats.attempted) * 100) 
        : 0;

      return (
        <div className="app-container">
          {/* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
          <div className="tab-nav">
            <button 
              className={`tab-button ${activeTab === 'dashboard' ? 'active' : ''}`}
              onClick={() => setActiveTab('dashboard')}
            >
              ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </button>
            <button 
              className={`tab-button ${activeTab === 'training' ? 'active' : ''}`}
              onClick={() => setActiveTab('training')}
            >
              âœï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
            </button>
            <button 
              className={`tab-button ${activeTab === 'analysis' ? 'active' : ''}`}
              onClick={() => setActiveTab('analysis')}
            >
              ğŸ“ˆ åˆ†æ
            </button>
          </div>

          {/* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */}
          <div className={`tab-content ${activeTab === 'dashboard' ? 'active' : ''}`}>
            <div className="dashboard">
              {/* ãƒ©ãƒ³ã‚¯è¡¨ç¤º */}
              <div className="card" style={{gridColumn: 'span 2'}}>
                <div className="rank-display">
                  <div className="rank-title">{currentRank.icon} {currentRank.name}</div>
                  <div className="rank-subtitle">çµŒé¨“å€¤: {stats.xp} XP</div>
                  <div className="xp-bar">
                    <div className="xp-fill" style={{width: `${rankProgress.percentage}%`}}></div>
                  </div>
                  <div className="xp-text">
                    æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§: {rankProgress.current} / {rankProgress.max} XP
                  </div>
                </div>
              </div>

              {/* ã‚¹ãƒˆãƒªãƒ¼ã‚¯ */}
              <div className="card">
                <div className="streak-display">
                  <div className="streak-icon">ğŸ”¥</div>
                  <div className="streak-info">
                    <div className="streak-number">{stats.streak}æ—¥</div>
                    <div className="streak-text">é€£ç¶šå­¦ç¿’ä¸­ï¼</div>
                  </div>
                </div>
              </div>

              {/* çµ±è¨ˆ */}
              <div className="card">
                <div className="card-title">ğŸ“Š å­¦ç¿’çµ±è¨ˆ</div>
                <div className="stats-grid">
                  <div className="stat-box">
                    <div className="stat-value">{stats.attempted}</div>
                    <div className="stat-label">æŒ‘æˆ¦æ•°</div>
                  </div>
                  <div className="stat-box">
                    <div className="stat-value">{stats.correct}</div>
                    <div className="stat-label">æ­£è§£æ•°</div>
                  </div>
                  <div className="stat-box" style={{gridColumn: 'span 2'}}>
                    <div className="stat-value">{accuracyRate}%</div>
                    <div className="stat-label">æ­£ç­”ç‡</div>
                  </div>
                </div>
              </div>

              {/* ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ */}
              <div className="card" style={{gridColumn: 'span 2'}}>
                <div className="card-title">ğŸ¯ åˆ†é‡åˆ¥ç¿’å¾—åº¦</div>
                <div className="chart-container">
                  <canvas ref={radarChartRef}></canvas>
                </div>
              </div>
            </div>

            <div style={{marginTop: '20px', textAlign: 'center'}}>
              <button className="btn btn-incorrect" onClick={resetStats}>
                ğŸ”„ çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>

          {/* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° */}
          <div className={`tab-content ${activeTab === 'training' ? 'active' : ''}`}>
            <div className="training-container">
              <div className="problem-card">
                <div className="problem-header">
                  <div className="problem-type">
                    {PROBLEM_TYPES[currentProblem.type]?.name || 'å•é¡Œ'}
                  </div>
                  <div className="problem-number">
                    å•é¡Œ #{stats.attempted + 1}
                  </div>
                </div>

                <div className="problem-display">
                  <MathDisplay latex={currentProblem.problem} block={true} />
                </div>

                {/* ãƒ’ãƒ³ãƒˆ */}
                {currentProblem.hint && (
                  <div className={`hint-section ${showHint ? 'show' : ''}`}>
                    <div className="hint-title">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</div>
                    <div>{currentProblem.hint}</div>
                  </div>
                )}

                {/* ç­”ãˆ */}
                <div className={`answer-section ${showAnswer ? 'show' : ''}`}>
                  <div className="answer-steps">
                    {currentProblem.steps.map((step, i) => (
                      <div key={i} className="step">
                        <MathDisplay latex={step} />
                      </div>
                    ))}
                  </div>
                  <div className="final-answer">
                    <div className="final-answer-label">ç­”ãˆ</div>
                    <div className="final-answer-value">
                      {currentProblem.isLatex ? (
                        <MathDisplay latex={currentProblem.answer} />
                      ) : (
                        currentProblem.answer
                      )}
                    </div>
                  </div>
                </div>

                {/* ãƒœã‚¿ãƒ³ */}
                <div className="button-group">
                  {!showAnswer && currentProblem.hint && !showHint && (
                    <button className="btn btn-hint" onClick={handleShowHint}>
                      ğŸ’¡ ãƒ’ãƒ³ãƒˆ
                    </button>
                  )}
                  {!showAnswer && (
                    <button className="btn btn-show" onClick={handleShowAnswer}>
                      ğŸ‘ ç­”ãˆã‚’è¦‹ã‚‹
                    </button>
                  )}
                  <button className="btn btn-correct" onClick={handleCorrect}>
                    âœ“ æ­£ç­”
                  </button>
                  <button className="btn btn-incorrect" onClick={handleIncorrect}>
                    âœ— å¤±æ•—
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* åˆ†æ */}
          <div className={`tab-content ${activeTab === 'analysis' ? 'active' : ''}`}>
            <div className="analysis-grid">
              <div className="card">
                <div className="card-title">âŒ ãƒŸã‚¹åˆ†æ</div>
                <div className="mistake-analysis">
                  {Object.keys(stats.mistakes).length > 0 ? (
                    <div className="mistake-list">
                      {MISTAKE_TYPES.map(type => {
                        const count = stats.mistakes[type] || 0;
                        const maxCount = Math.max(...Object.values(stats.mistakes));
                        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                        
                        return (
                          <div key={type} className="mistake-item">
                            <div className="mistake-name">{type}</div>
                            <div className="mistake-count">
                              <div className="mistake-bar">
                                <div className="mistake-bar-fill" style={{width: `${percentage}%`}}></div>
                              </div>
                              <div className="mistake-number">{count}å›</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{textAlign: 'center', color: '#7f8c8d', padding: '40px 0'}}>
                      ã¾ã ãƒŸã‚¹ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                    </p>
                  )}
                </div>
              </div>

              <div className="card">
                <div className="card-title">ğŸ’¬ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
                <div style={{padding: '20px', background: '#f8f9fa', borderRadius: '10px', lineHeight: 1.8}}>
                  {stats.attempted === 0 ? (
                    <p>ã¾ãšã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                  ) : accuracyRate >= 80 ? (
                    <p>ç´ æ™´ã‚‰ã—ã„ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã† ğŸ‰</p>
                  ) : accuracyRate >= 60 ? (
                    <p>è‰¯ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼å¾©ç¿’ã‚’é‡ã­ã¦å®šç€ã•ã›ã¾ã—ã‚‡ã† ğŸ’ª</p>
                  ) : (
                    <p>åŸºç¤ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ä¸€å•ä¸€å•ä¸å¯§ã«ï¼ğŸ“š</p>
                  )}
                  
                  {stats.mistakes['ç¬¦å·ã®ãƒŸã‚¹'] > 5 && (
                    <p style={{marginTop: '15px', color: '#e74c3c'}}>
                      âš ï¸ ç¬¦å·ã®ãƒŸã‚¹ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚è¨ˆç®—ã®éš›ã¯ç‰¹ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚
                    </p>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* ãƒŸã‚¹åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« */}
          <div className={`modal ${showMistakeModal ? 'show' : ''}`}>
            <div className="modal-content">
              <div className="modal-title">ã©ã“ã§é–“é•ãˆã¾ã—ãŸã‹ï¼Ÿ</div>
              <div className="mistake-options">
                {MISTAKE_TYPES.map(type => (
                  <div 
                    key={type}
                    className="mistake-option"
                    onClick={() => recordMistake(type)}
                  >
                    {type}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // å•é¡Œç”Ÿæˆé–¢æ•°ã‚’è¿”ã™
    function generateAllProblemFunctions() {
      return \`
        const generateProblem = () => {
          const types = Object.keys(PROBLEM_TYPES);
          const type = types[Math.floor(Math.random() * types.length)];
          
          const generators = {
            trigonometric: generateTrigonometric,
            exponential: generateExponential,
            rational: generateRational,
            poly_trig: generatePolyTrig,
            poly_exp: generatePolyExp,
            substitution: generateSubstitution,
            parts: generateParts,
            sqrt_function: generateSqrtFunction,
            log_power: generateLogPower,
            trig_power: generateTrigPower,
            derivative_over_function: generateDerivativeOverFunction,
            log_derivative: generateLogDerivative
          };
          
          const problem = generators[type]();
          problem.type = type;
          return problem;
        };

        // å„å•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆå‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼‰
        const generateTrigonometric = () => {
          const funcs = [
            { name: '\\\\sin', integral: '-\\\\cos', 
              calc: (u, l) => -Math.cos(u) + Math.cos(l),
              answerFunc: (u) => {
                if (u === Math.PI/2) return { latex: '1', isLatex: false };
                if (u === Math.PI/3) return { latex: '\\\\frac{1}{2}', isLatex: true };
                if (u === Math.PI/4) return { latex: '1 - \\\\frac{\\\\sqrt{2}}{2}', isLatex: true };
                if (u === Math.PI/6) return { latex: '1 - \\\\frac{\\\\sqrt{3}}{2}', isLatex: true };
              }
            },
            { name: '\\\\cos', integral: '\\\\sin',
              calc: (u, l) => Math.sin(u) - Math.sin(l),
              answerFunc: (u) => {
                if (u === Math.PI/2) return { latex: '1', isLatex: false };
                if (u === Math.PI/3) return { latex: '\\\\frac{\\\\sqrt{3}}{2}', isLatex: true };
                if (u === Math.PI/4) return { latex: '\\\\frac{\\\\sqrt{2}}{2}', isLatex: true };
                if (u === Math.PI/6) return { latex: '\\\\frac{1}{2}', isLatex: true };
              }
            }
          ];
          
          const func = funcs[Math.floor(Math.random() * funcs.length)];
          const upperChoices = [Math.PI/6, Math.PI/4, Math.PI/3, Math.PI/2];
          const upper = upperChoices[Math.floor(Math.random() * upperChoices.length)];
          
          const upperStr = upper === Math.PI/2 ? '\\\\frac{\\\\pi}{2}' : 
                           upper === Math.PI/3 ? '\\\\frac{\\\\pi}{3}' :
                           upper === Math.PI/4 ? '\\\\frac{\\\\pi}{4}' : '\\\\frac{\\\\pi}{6}';
          
          const answerObj = func.answerFunc(upper);
          
          return {
            problem: \`\\\\int_{0}^{\${upperStr}} \${func.name} x \\\\, dx\`,
            steps: [
              \`\\\\text{åŸå§‹é–¢æ•°: } \\\\int \${func.name} x \\\\, dx = \${func.integral} x + C\`,
              \`\\\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\\\left[ \${func.integral} x \\\\right]_{0}^{\${upperStr}}\`,
              \`\\\\text{ä»£å…¥ã—ã¦è¨ˆç®—}\`
            ],
            answer: answerObj.latex,
            isLatex: answerObj.isLatex,
            hint: 'ä¸‰è§’é–¢æ•°ã®åŸºæœ¬çš„ãªç©åˆ†å…¬å¼ã‚’ä½¿ã„ã¾ã™'
          };
        };

        const generateExponential = () => {
          const a = Math.floor(Math.random() * 3) + 1;
          const upper = Math.floor(Math.random() * 2) + 1;
          
          let answerLatex;
          if (upper === 1) {
            answerLatex = a === 1 ? 'e - 1' : \`\${a}(e - 1)\`;
          } else {
            answerLatex = a === 1 ? \`e^{\${upper}} - 1\` : \`\${a}(e^{\${upper}} - 1)\`;
          }
          
          const aStr = a === 1 ? '' : \`\${a}\`;
          const integral = a === 1 ? 'e^{x}' : \`\${a}e^{x}\`;
          
          return {
            problem: \`\\\\int_{0}^{\${upper}} \${aStr}e^{x} \\\\, dx\`,
            steps: [
              \`\\\\text{åŸå§‹é–¢æ•°: } \\\\int \${aStr}e^{x} \\\\, dx = \${integral} + C\`,
              \`\\\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\\\left[ \${integral} \\\\right]_{0}^{\${upper}}\`,
              \`= \${aStr}e^{\${upper}} - \${aStr}e^{0}\`,
              upper === 1 ? \`= \${aStr}e - \${a}\` : \`= \${a === 1 ? '' : a}(e^{\${upper}} - 1)\`
            ],
            answer: answerLatex,
            isLatex: true,
            hint: 'æŒ‡æ•°é–¢æ•°ã®ç©åˆ†ã¯å…ƒã®å½¢ãŒä¿ãŸã‚Œã¾ã™'
          };
        };

        const generateRational = () => {
          const upper = Math.floor(Math.random() * 3) + 2;
          
          return {
            problem: \`\\\\int_{1}^{\${upper}} \\\\frac{1}{x} \\\\, dx\`,
            steps: [
              \`\\\\text{åŸå§‹é–¢æ•°: } \\\\int \\\\frac{1}{x} \\\\, dx = \\\\log |x| + C\`,
              \`\\\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\\\left[ \\\\log x \\\\right]_{1}^{\${upper}}\`,
              \`= \\\\log \${upper} - \\\\log 1\`,
              \`= \\\\log \${upper}\`
            ],
            answer: \`\\\\log \${upper}\`,
            isLatex: true,
            hint: '1/x ã®ç©åˆ†ã¯å¯¾æ•°é–¢æ•°ã§ã™'
          };
        };

        const generatePolyTrig = () => {
          const patterns = [
            {
              problem: \`\\\\int_{0}^{\\\\frac{\\\\pi}{2}} x \\\\sin x \\\\, dx\`,
              steps: [
                \`\\\\text{éƒ¨åˆ†ç©åˆ†: } u = x, \\\\, dv = \\\\sin x \\\\, dx\`,
                \`du = dx, \\\\, v = -\\\\cos x\`,
                \`= [-x \\\\cos x]_{0}^{\\\\frac{\\\\pi}{2}} + \\\\int_{0}^{\\\\frac{\\\\pi}{2}} \\\\cos x \\\\, dx\`,
                \`= 0 + [\\\\sin x]_{0}^{\\\\frac{\\\\pi}{2}}\`,
                \`= 1\`
              ],
              answer: '1',
              isLatex: false,
              hint: 'éƒ¨åˆ†ç©åˆ†æ³•ã‚’ä½¿ã„ã¾ã™: âˆ«udv = uv - âˆ«vdu'
            }
          ];
          
          return patterns[0];
        };

        const generatePolyExp = () => {
          return {
            problem: \`\\\\int_{0}^{1} xe^{x} \\\\, dx\`,
            steps: [
              \`\\\\text{éƒ¨åˆ†ç©åˆ†: } u = x, \\\\, dv = e^{x} \\\\, dx\`,
              \`du = dx, \\\\, v = e^{x}\`,
              \`= [xe^{x}]_{0}^{1} - \\\\int_{0}^{1} e^{x} \\\\, dx\`,
              \`= e - [e^{x}]_{0}^{1}\`,
              \`= e - (e - 1) = 1\`
            ],
            answer: '1',
            isLatex: false,
            hint: 'éƒ¨åˆ†ç©åˆ†æ³•ã‚’ä½¿ã„ã¾ã™'
          };
        };

        const generateSubstitution = () => {
          return {
            problem: \`\\\\int_{0}^{\\\\frac{\\\\pi}{4}} \\\\tan x \\\\, dx\`,
            steps: [
              \`\\\\int \\\\tan x \\\\, dx = \\\\int \\\\frac{\\\\sin x}{\\\\cos x} \\\\, dx\`,
              \`t = \\\\cos x \\\\text{ ã¨ãŠãã¨ } dt = -\\\\sin x \\\\, dx\`,
              \`= -\\\\int \\\\frac{1}{t} \\\\, dt = -\\\\log |t|\`,
              \`= [-\\\\log \\\\cos x]_{0}^{\\\\frac{\\\\pi}{4}}\`,
              \`= \\\\frac{1}{2}\\\\log 2\`
            ],
            answer: '\\\\frac{1}{2}\\\\log 2',
            isLatex: true,
            hint: 't = cos x ã¨ç½®æ›ã—ã¦ã¿ã¾ã—ã‚‡ã†'
          };
        };

        const generateParts = () => {
          return {
            problem: \`\\\\int_{1}^{e} \\\\log x \\\\, dx\`,
            steps: [
              \`\\\\text{éƒ¨åˆ†ç©åˆ†: } u = \\\\log x, \\\\, dv = dx\`,
              \`du = \\\\frac{1}{x} \\\\, dx, \\\\, v = x\`,
              \`= [x \\\\log x]_{1}^{e} - \\\\int_{1}^{e} x \\\\cdot \\\\frac{1}{x} \\\\, dx\`,
              \`= (e \\\\cdot 1 - 1 \\\\cdot 0) - [x]_{1}^{e}\`,
              \`= e - (e - 1) = 1\`
            ],
            answer: '1',
            isLatex: false,
            hint: 'log x ã‚’ u ã¨ã—ã¦éƒ¨åˆ†ç©åˆ†ã—ã¾ã™'
          };
        };

        const generateSqrtFunction = () => {
          return {
            problem: \`\\\\int_{0}^{3} \\\\sqrt{x + 1} \\\\, dx\`,
            steps: [
              \`t = x + 1 \\\\text{ ã¨ãŠãã¨ } dt = dx\`,
              \`x: 0 \\\\to 3 \\\\text{ ã®ã¨ã } t: 1 \\\\to 4\`,
              \`= \\\\int_{1}^{4} t^{\\\\frac{1}{2}} \\\\, dt\`,
              \`= \\\\left[ \\\\frac{2}{3}t^{\\\\frac{3}{2}} \\\\right]_{1}^{4}\`,
              \`= \\\\frac{2}{3}(8 - 1) = \\\\frac{14}{3}\`
            ],
            answer: '\\\\frac{14}{3}',
            isLatex: true,
            hint: 't = x + 1 ã¨ç½®æ›ã—ã¾ã™'
          };
        };

        const generateLogPower = () => {
          return {
            problem: \`\\\\int_{1}^{e} \\\\frac{(\\\\log x)^{2}}{x} \\\\, dx\`,
            steps: [
              \`t = \\\\log x \\\\text{ ã¨ãŠãã¨ } dt = \\\\frac{1}{x} \\\\, dx\`,
              \`x: 1 \\\\to e \\\\text{ ã®ã¨ã } t: 0 \\\\to 1\`,
              \`= \\\\int_{0}^{1} t^{2} \\\\, dt\`,
              \`= \\\\left[ \\\\frac{t^{3}}{3} \\\\right]_{0}^{1}\`,
              \`= \\\\frac{1}{3}\`
            ],
            answer: '\\\\frac{1}{3}',
            isLatex: true,
            hint: 't = log x ã¨ç½®æ›ã—ã¾ã™'
          };
        };

        const generateTrigPower = () => {
          return {
            problem: \`\\\\int_{0}^{\\\\frac{\\\\pi}{2}} \\\\sin^{2} x \\\\, dx\`,
            steps: [
              \`\\\\text{åŠè§’ã®å…¬å¼: } \\\\sin^{2} x = \\\\frac{1 - \\\\cos 2x}{2}\`,
              \`= \\\\int_{0}^{\\\\frac{\\\\pi}{2}} \\\\frac{1 - \\\\cos 2x}{2} \\\\, dx\`,
              \`= \\\\left[ \\\\frac{x}{2} - \\\\frac{\\\\sin 2x}{4} \\\\right]_{0}^{\\\\frac{\\\\pi}{2}}\`,
              \`= \\\\frac{\\\\pi}{4}\`
            ],
            answer: '\\\\frac{\\\\pi}{4}',
            isLatex: true,
            hint: 'åŠè§’ã®å…¬å¼ã‚’ä½¿ã„ã¾ã™: sinÂ²x = (1-cos2x)/2'
          };
        };

        const generateDerivativeOverFunction = () => {
          return {
            problem: \`\\\\int_{1}^{2} \\\\frac{2x}{x^{2} + 1} \\\\, dx\`,
            steps: [
              \`\\\\text{åˆ†å­ã¯åˆ†æ¯ã®å°é–¢æ•°: } (x^{2} + 1)' = 2x\`,
              \`t = x^{2} + 1 \\\\text{ ã¨ãŠãã¨ } dt = 2x \\\\, dx\`,
              \`x: 1 \\\\to 2 \\\\text{ ã®ã¨ã } t: 2 \\\\to 5\`,
              \`= \\\\int_{2}^{5} \\\\frac{1}{t} \\\\, dt = [\\\\log t]_{2}^{5}\`,
              \`= \\\\log \\\\frac{5}{2}\`
            ],
            answer: '\\\\log \\\\frac{5}{2}',
            isLatex: true,
            hint: 'åˆ†å­ãŒåˆ†æ¯ã®å°é–¢æ•°ã«ãªã£ã¦ã„ã¾ã™'
          };
        };

        const generateLogDerivative = () => {
          return {
            problem: \`\\\\int_{1}^{e} \\\\frac{1}{x(\\\\log x + 1)} \\\\, dx\`,
            steps: [
              \`\\\\text{å¯¾æ•°å¾®åˆ†å‹ã‚’åˆ©ç”¨}\`,
              \`\\\\frac{d}{dx}[\\\\log(\\\\log x + 1)] = \\\\frac{1}{x(\\\\log x + 1)}\`,
              \`= [\\\\log(\\\\log x + 1)]_{1}^{e}\`,
              \`= \\\\log 2 - \\\\log 1 = \\\\log 2\`
            ],
            answer: '\\\\log 2',
            isLatex: true,
            hint: 'å¯¾æ•°å¾®åˆ†ã®å…¬å¼ã‚’æ€ã„å‡ºã—ã¾ã—ã‚‡ã†'
          };
        };
      \`;
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<IntegrationMasterApp />);
  </script>
</body>
</html>
