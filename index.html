<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®šç©åˆ†ãƒã‚¹ã‚¿ãƒ¼ - æˆé•·ãŒè¦‹ãˆã‚‹ç·´ç¿’å¸³</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 30px; font-size: 2.2rem; }
    
    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 15px;
    }
    .tab {
      flex: 1;
      padding: 15px;
      border: none;
      background: rgba(255,255,255,0.3);
      color: white;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab.active { background: white; color: #667eea; }
    .tab:hover:not(.active) { background: rgba(255,255,255,0.4); }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .content { display: none; }
    .content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: white;
      color: #333;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .card h2 { margin-bottom: 20px; color: #2c3e50; }
    
    /* ãƒ©ãƒ³ã‚¯ */
    .rank {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    .rank-title { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; }
    .rank-xp { font-size: 1.2rem; margin-bottom: 20px; }
    .xp-bar {
      background: rgba(255,255,255,0.3);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }
    .xp-fill {
      height: 100%;
      background: white;
      transition: width 0.5s;
    }
    
    /* çµ±è¨ˆ */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .stat {
      text-align: center;
      padding: 25px;
      background: #f5f7fa;
      border-radius: 12px;
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 8px;
    }
    
    /* ã‚¹ãƒˆãƒªãƒ¼ã‚¯ */
    .streak {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 30px;
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      border-radius: 15px;
    }
    .streak-icon { font-size: 3.5rem; }
    .streak-number { font-size: 2.5rem; font-weight: bold; }
    
    /* å•é¡Œ */
    .problem-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e1e8ed;
    }
    .problem-type {
      background: #667eea;
      color: white;
      padding: 8px 18px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.95rem;
    }
    .problem-display {
      font-size: 2rem;
      text-align: center;
      padding: 50px 30px;
      background: #f8f9fa;
      border-radius: 15px;
      margin: 25px 0;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.6;
    }
    
    /* ãƒ’ãƒ³ãƒˆ */
    .hint {
      background: #fff9e6;
      border-left: 4px solid #ffd700;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    .hint.show { display: block; }
    .hint-title { font-weight: bold; color: #d4a600; margin-bottom: 10px; }
    
    /* ç­”ãˆ */
    .answer {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 25px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    .answer.show { display: block; }
    .steps { margin-bottom: 20px; }
    .step {
      padding: 15px;
      margin: 10px 0;
      background: white;
      border-radius: 8px;
      font-size: 1.1rem;
      line-height: 1.8;
    }
    .final-answer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
    }
    .final-answer-label { font-size: 1rem; margin-bottom: 10px; opacity: 0.9; }
    .final-answer-value { font-size: 2.2rem; font-weight: bold; }
    
    /* ãƒœã‚¿ãƒ³ */
    .buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 25px;
    }
    .btn {
      padding: 16px 25px;
      font-size: 1.05rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .btn-hint { background: #ffd700; color: #333; }
    .btn-show { background: #9b59b6; color: white; }
    .btn-correct { background: #2ecc71; color: white; }
    .btn-wrong { background: #e74c3c; color: white; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      color: #333;
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 25px;
      text-align: center;
    }
    .mistake-options { display: grid; gap: 12px; }
    .mistake-option {
      padding: 16px;
      background: #f8f9fa;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      transition: all 0.2s;
    }
    .mistake-option:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
    }
    
    /* ãƒŸã‚¹åˆ†æ */
    .mistake-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .mistake-bar {
      width: 120px;
      height: 10px;
      background: #e1e8ed;
      border-radius: 5px;
      overflow: hidden;
      margin: 0 15px;
    }
    .mistake-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.5s;
    }
    .mistake-count {
      font-weight: bold;
      color: #667eea;
      min-width: 50px;
      text-align: right;
    }
    
    @media (max-width: 768px) {
      .stats { grid-template-columns: 1fr; }
      .buttons { grid-template-columns: 1fr; }
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š å®šç©åˆ†ãƒã‚¹ã‚¿ãƒ¼ - æˆé•·ãŒè¦‹ãˆã‚‹ç·´ç¿’å¸³</h1>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
      <button class="tab" onclick="switchTab('training')">âœï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button>
      <button class="tab" onclick="switchTab('analysis')">ğŸ“ˆ åˆ†æ</button>
    </div>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="dashboard" class="content active">
      <div class="rank">
        <div class="rank-title" id="rankName">ğŸŒ± ç©åˆ†è¦‹ç¿’ã„</div>
        <div class="rank-xp">çµŒé¨“å€¤: <span id="xp">0</span> XP</div>
        <div class="xp-bar">
          <div class="xp-fill" id="xpBar" style="width: 0%"></div>
        </div>
        <div style="margin-top: 10px; font-size: 0.95rem;">
          æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§: <span id="xpNext">0 / 50</span> XP
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Š å­¦ç¿’çµ±è¨ˆ</h2>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="attempted">0</div>
            <div class="stat-label">æŒ‘æˆ¦æ•°</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="correct">0</div>
            <div class="stat-label">æ­£è§£æ•°</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="accuracy">0%</div>
            <div class="stat-label">æ­£ç­”ç‡</div>
          </div>
        </div>
      </div>

      <div class="streak">
        <div class="streak-icon">ğŸ”¥</div>
        <div>
          <div class="streak-number"><span id="streak">0</span>æ—¥</div>
          <div style="font-size: 1.1rem;">é€£ç¶šå­¦ç¿’ä¸­ï¼</div>
        </div>
      </div>
    </div>

    <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° -->
    <div id="training" class="content">
      <div class="card">
        <div class="problem-header">
          <div class="problem-type" id="problemType">ä¸‰è§’é–¢æ•°</div>
          <div style="color: #7f8c8d;">å•é¡Œ #<span id="problemNum">1</span></div>
        </div>

        <div class="problem-display" id="problemText">âˆ«â‚€^(Ï€/2) sin x dx</div>

        <div class="hint" id="hint">
          <div class="hint-title">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</div>
          <div id="hintText">ä¸‰è§’é–¢æ•°ã®åŸºæœ¬çš„ãªç©åˆ†å…¬å¼ã‚’ä½¿ã„ã¾ã™</div>
        </div>

        <div class="answer" id="answer">
          <div class="steps">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">è§£æ³•</h3>
            <div id="steps"></div>
          </div>
          <div class="final-answer">
            <div class="final-answer-label">ç­”ãˆ</div>
            <div class="final-answer-value" id="finalAnswer">1</div>
          </div>
        </div>

        <div class="buttons">
          <button class="btn btn-hint" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
          <button class="btn btn-show" onclick="showAnswer()">ğŸ‘ ç­”ãˆã‚’è¦‹ã‚‹</button>
          <button class="btn btn-correct" onclick="handleCorrect()">âœ“ æ­£ç­”</button>
          <button class="btn btn-wrong" onclick="showMistakeModal()">âœ— å¤±æ•—</button>
        </div>
      </div>
    </div>

    <!-- åˆ†æ -->
    <div id="analysis" class="content">
      <div class="card">
        <h2>âŒ ãƒŸã‚¹åˆ†æ</h2>
        <div id="mistakeList"></div>
      </div>

      <div class="card">
        <h2>ğŸ’¬ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
        <div style="padding: 25px; background: #f8f9fa; border-radius: 12px; line-height: 1.8;">
          <div id="advice">ã¾ãšã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</div>
        </div>
      </div>
    </div>

    <!-- ãƒŸã‚¹è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="mistakeModal">
      <div class="modal-content">
        <div class="modal-title">ã©ã“ã§é–“é•ãˆã¾ã—ãŸã‹ï¼Ÿ</div>
        <div class="mistake-options">
          <div class="mistake-option" onclick="recordMistake('ç©åˆ†å…¬å¼ã®å¿˜ã‚Œ')">ç©åˆ†å…¬å¼ã®å¿˜ã‚Œ</div>
          <div class="mistake-option" onclick="recordMistake('ç¬¦å·ã®ãƒŸã‚¹')">ç¬¦å·ã®ãƒŸã‚¹</div>
          <div class="mistake-option" onclick="recordMistake('ä»£å…¥è¨ˆç®—ã®ãƒŸã‚¹')">ä»£å…¥è¨ˆç®—ã®ãƒŸã‚¹</div>
          <div class="mistake-option" onclick="recordMistake('æ–¹é‡ã®é–“é•ã„')">æ–¹é‡ã®é–“é•ã„</div>
          <div class="mistake-option" onclick="recordMistake('ãã®ä»–')">ãã®ä»–</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script>
    // ãƒ©ãƒ³ã‚¯å®šç¾©
    const RANKS = [
      { name: 'ğŸŒ± ç©åˆ†è¦‹ç¿’ã„', min: 0 },
      { name: 'ğŸŒ¿ ç©åˆ†åˆç´šè€…', min: 50 },
      { name: 'ğŸŒ³ ç©åˆ†ä¸­ç´šè€…', min: 150 },
      { name: 'â­ ç©åˆ†ä¸Šç´šè€…', min: 300 },
      { name: 'ğŸ’« ç©åˆ†é”äºº', min: 500 },
      { name: 'ğŸ”® ç©åˆ†é­”è¡“å¸«', min: 1000 }
    ];

    // å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    const PROBLEMS = [
      {
        type: 'ä¸‰è§’é–¢æ•°',
        problem: '\\int_{0}^{\\frac{\\pi}{2}} \\sin x \\, dx',
        hint: 'ä¸‰è§’é–¢æ•°ã®åŸºæœ¬çš„ãªç©åˆ†å…¬å¼ã‚’ä½¿ã„ã¾ã™',
        steps: [
          '\\int \\sin x \\, dx = -\\cos x + C',
          '\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\left[ -\\cos x \\right]_{0}^{\\frac{\\pi}{2}}',
          '= -\\cos\\left(\\frac{\\pi}{2}\\right) - (-\\cos 0)',
          '= 0 + 1 = 1'
        ],
        answer: '1'
      },
      {
        type: 'æŒ‡æ•°é–¢æ•°',
        problem: '\\int_{0}^{1} e^{x} \\, dx',
        hint: 'æŒ‡æ•°é–¢æ•°ã®ç©åˆ†ã¯å…ƒã®å½¢ãŒä¿ãŸã‚Œã¾ã™',
        steps: [
          '\\int e^{x} \\, dx = e^{x} + C',
          '\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\left[ e^{x} \\right]_{0}^{1}',
          '= e^{1} - e^{0}',
          '= e - 1'
        ],
        answer: 'e - 1'
      },
      {
        type: 'å¯¾æ•°é–¢æ•°',
        problem: '\\int_{1}^{e} \\frac{1}{x} \\, dx',
        hint: '1/x ã®ç©åˆ†ã¯å¯¾æ•°é–¢æ•°ã§ã™',
        steps: [
          '\\int \\frac{1}{x} \\, dx = \\log |x| + C',
          '\\text{å®šç©åˆ†ã®è¨ˆç®—: } \\left[ \\log x \\right]_{1}^{e}',
          '= \\log e - \\log 1',
          '= 1 - 0 = 1'
        ],
        answer: '1'
      },
      {
        type: 'ç½®æ›ç©åˆ†',
        problem: '\\int_{0}^{3} \\sqrt{x+1} \\, dx',
        hint: 't = x + 1 ã¨ç½®æ›ã—ã¾ã™',
        steps: [
          't = x + 1 \\text{ ã¨ãŠãã¨ } dt = dx',
          'x: 0 \\to 3 \\text{ ã®ã¨ã } t: 1 \\to 4',
          '= \\int_{1}^{4} t^{\\frac{1}{2}} \\, dt',
          '= \\left[ \\frac{2}{3}t^{\\frac{3}{2}} \\right]_{1}^{4}',
          '= \\frac{2}{3}(8 - 1) = \\frac{14}{3}'
        ],
        answer: '\\frac{14}{3}'
      },
      {
        type: 'éƒ¨åˆ†ç©åˆ†',
        problem: '\\int_{0}^{\\frac{\\pi}{2}} x \\sin x \\, dx',
        hint: 'éƒ¨åˆ†ç©åˆ†æ³•: âˆ«udv = uv - âˆ«vdu',
        steps: [
          'u = x, \\, dv = \\sin x \\, dx \\text{ ã¨ãŠã}',
          'du = dx, \\, v = -\\cos x',
          '= \\left[ -x \\cos x \\right]_{0}^{\\frac{\\pi}{2}} + \\int_{0}^{\\frac{\\pi}{2}} \\cos x \\, dx',
          '= 0 + \\left[ \\sin x \\right]_{0}^{\\frac{\\pi}{2}}',
          '= 1'
        ],
        answer: '1'
      },
      {
        type: 'ä¸‰è§’é–¢æ•°ç´¯ä¹—',
        problem: '\\int_{0}^{\\frac{\\pi}{2}} \\sin^{2} x \\, dx',
        hint: 'åŠè§’ã®å…¬å¼: sinÂ²x = (1 - cos 2x)/2',
        steps: [
          '\\sin^{2} x = \\frac{1 - \\cos 2x}{2}',
          '= \\int_{0}^{\\frac{\\pi}{2}} \\frac{1 - \\cos 2x}{2} \\, dx',
          '= \\left[ \\frac{x}{2} - \\frac{\\sin 2x}{4} \\right]_{0}^{\\frac{\\pi}{2}}',
          '= \\frac{\\pi}{4} - 0 = \\frac{\\pi}{4}'
        ],
        answer: '\\frac{\\pi}{4}'
      }
    ];

    const MISTAKE_TYPES = ['ç©åˆ†å…¬å¼ã®å¿˜ã‚Œ', 'ç¬¦å·ã®ãƒŸã‚¹', 'ä»£å…¥è¨ˆç®—ã®ãƒŸã‚¹', 'æ–¹é‡ã®é–“é•ã„', 'ãã®ä»–'];

    // çŠ¶æ…‹ç®¡ç†
    let stats = {
      attempted: 0,
      correct: 0,
      streak: 0,
      xp: 0,
      mistakes: {}
    };
    let currentProblem = 0;
    let showingHint = false;
    let showingAnswer = false;

    // åˆæœŸåŒ–
    function init() {
      const saved = localStorage.getItem('integrationMasterStats');
      if (saved) {
        stats = JSON.parse(saved);
      }
      loadProblem();
      updateDisplay();
    }

    // è¡¨ç¤ºæ›´æ–°
    function updateDisplay() {
      document.getElementById('attempted').textContent = stats.attempted;
      document.getElementById('correct').textContent = stats.correct;
      const acc = stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
      document.getElementById('accuracy').textContent = acc + '%';
      document.getElementById('xp').textContent = stats.xp;
      document.getElementById('streak').textContent = stats.streak;
      document.getElementById('problemNum').textContent = stats.attempted + 1;

      // ãƒ©ãƒ³ã‚¯æ›´æ–°
      let rank = RANKS[0];
      let nextRank = RANKS[1];
      for (let i = RANKS.length - 1; i >= 0; i--) {
        if (stats.xp >= RANKS[i].min) {
          rank = RANKS[i];
          nextRank = RANKS[Math.min(i + 1, RANKS.length - 1)];
          break;
        }
      }
      document.getElementById('rankName').textContent = rank.name;
      
      const current = stats.xp - rank.min;
      const max = nextRank.min - rank.min;
      const pct = max > 0 ? Math.round((current / max) * 100) : 100;
      document.getElementById('xpBar').style.width = pct + '%';
      document.getElementById('xpNext').textContent = `${current} / ${max}`;

      // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
      let advice = 'ã¾ãšã¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼';
      if (stats.attempted > 0) {
        if (acc >= 80) advice = 'ç´ æ™´ã‚‰ã—ã„ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã† ğŸ‰';
        else if (acc >= 60) advice = 'è‰¯ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼å¾©ç¿’ã‚’é‡ã­ã¦å®šç€ã•ã›ã¾ã—ã‚‡ã† ğŸ’ª';
        else advice = 'åŸºç¤ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ä¸€å•ä¸€å•ä¸å¯§ã«ï¼ğŸ“š';
        
        if (stats.mistakes['ç¬¦å·ã®ãƒŸã‚¹'] > 5) {
          advice += '<br><br>âš ï¸ ç¬¦å·ã®ãƒŸã‚¹ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚è¨ˆç®—ã®éš›ã¯ç‰¹ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚';
        }
      }
      document.getElementById('advice').innerHTML = advice;

      // ãƒŸã‚¹åˆ†ææ›´æ–°
      updateMistakeAnalysis();
    }

    // å•é¡Œèª­ã¿è¾¼ã¿
    function loadProblem() {
      currentProblem = Math.floor(Math.random() * PROBLEMS.length);
      const problem = PROBLEMS[currentProblem];
      
      document.getElementById('problemType').textContent = problem.type;
      
      // KaTeXã§æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      renderMath('problemText', problem.problem);
      document.getElementById('hintText').textContent = problem.hint;
      renderMath('finalAnswer', problem.answer);
      
      // ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
      const stepsDiv = document.getElementById('steps');
      stepsDiv.innerHTML = '';
      problem.steps.forEach((step, i) => {
        const div = document.createElement('div');
        div.className = 'step';
        const stepNum = document.createElement('span');
        stepNum.textContent = `${i + 1}. `;
        div.appendChild(stepNum);
        
        const mathSpan = document.createElement('span');
        div.appendChild(mathSpan);
        stepsDiv.appendChild(div);
        
        // æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        try {
          katex.render(step, mathSpan, { throwOnError: false, displayMode: false });
        } catch (e) {
          mathSpan.textContent = step;
        }
      });

      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('hint').classList.remove('show');
      document.getElementById('answer').classList.remove('show');
      showingHint = false;
      showingAnswer = false;
    }

    // KaTeXæ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderMath(elementId, latex) {
      const element = document.getElementById(elementId);
      try {
        katex.render(latex, element, { throwOnError: false, displayMode: true });
      } catch (e) {
        element.textContent = latex;
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    function showHint() {
      document.getElementById('hint').classList.add('show');
      showingHint = true;
    }

    // ç­”ãˆè¡¨ç¤º
    function showAnswer() {
      document.getElementById('answer').classList.add('show');
      showingAnswer = true;
    }

    // æ­£ç­”å‡¦ç†
    function handleCorrect() {
      const xp = showingAnswer ? 5 : showingHint ? 8 : 10;
      stats.attempted++;
      stats.correct++;
      stats.streak++;
      stats.xp += xp;
      save();
      loadProblem();
      updateDisplay();
    }

    // ãƒŸã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showMistakeModal() {
      document.getElementById('mistakeModal').classList.add('show');
    }

    // ãƒŸã‚¹è¨˜éŒ²
    function recordMistake(type) {
      stats.attempted++;
      stats.xp += 2;
      if (!stats.mistakes[type]) stats.mistakes[type] = 0;
      stats.mistakes[type]++;
      save();
      document.getElementById('mistakeModal').classList.remove('show');
      loadProblem();
      updateDisplay();
    }

    // ãƒŸã‚¹åˆ†ææ›´æ–°
    function updateMistakeAnalysis() {
      const listDiv = document.getElementById('mistakeList');
      listDiv.innerHTML = '';
      
      if (Object.keys(stats.mistakes).length === 0) {
        listDiv.innerHTML = '<p style="text-align:center;color:#7f8c8d;padding:40px">ã¾ã ãƒŸã‚¹ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      const max = Math.max(...Object.values(stats.mistakes));
      
      MISTAKE_TYPES.forEach(type => {
        const count = stats.mistakes[type] || 0;
        const pct = max > 0 ? (count / max) * 100 : 0;
        
        const div = document.createElement('div');
        div.className = 'mistake-item';
        div.innerHTML = `
          <div style="font-weight:600">${type}</div>
          <div style="display:flex;align-items:center">
            <div class="mistake-bar">
              <div class="mistake-bar-fill" style="width:${pct}%"></div>
            </div>
            <div class="mistake-count">${count}å›</div>
          </div>
        `;
        listDiv.appendChild(div);
      });
    }

    // ä¿å­˜
    function save() {
      localStorage.setItem('integrationMasterStats', JSON.stringify(stats));
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('mistakeModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
      }
    });

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
